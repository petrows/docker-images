---
on:
  - push

name: Docker build
jobs:
  docker-detect:
    name: Detect docker images to build
    runs-on: self-hosted
    container:
      image: ghcr.io/petrows/podman:5.7.0-1
      options: -u 0 --privileged
    outputs:
      images: ${{ steps.detect.outputs.images }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect new tags
        id: detect
        run: |
          ./bin/build_docker.py --detect-images >> "$GITHUB_OUTPUT"
  docker-build:
    name: Build
    runs-on: self-hosted
    container:
      image: ghcr.io/petrows/podman:5.7.0-1
      options: -u 0 --privileged
      volumes:
        - /tmp/podman-storage:/var/lib/containers/storage
    needs: docker-detect
    strategy:
      matrix:
        image: ${{ fromJSON(needs.docker-detect.outputs.images) }}
    steps:
      - uses: actions/checkout@v4
      - name: Build ${{ matrix.image }}
        run: |
          docker login ghcr.io -u petrows -p ${{ secrets.DOCKER_TOKEN }}
          echo "Build: ${{ matrix.image }}"
          ./bin/build_docker.py --build ${{ matrix.image }} | tee build.sh
          source build.sh
  docker-deploy:
    name: Deploy
    if: success() && github.ref == 'refs/heads/master'
    runs-on: self-hosted
    container:
      image: ghcr.io/petrows/podman:5.7.0-1
      options: -u 0 --privileged
      volumes:
        - /tmp/podman-storage:/var/lib/containers/storage
    needs:
      - docker-detect
      - docker-build
    strategy:
      matrix:
        image: ${{ fromJSON(needs.docker-detect.outputs.images) }}
    steps:
      - uses: actions/checkout@v4
      - name: Deploy ${{ matrix.image }}
        run: |
          docker login ghcr.io -u petrows -p ${{ secrets.DOCKER_TOKEN }}
          echo "Deploy: ${{ matrix.image }}"
          ./bin/build_docker.py --deploy ${{ matrix.image }} | tee deploy.sh
          source deploy.sh
